name: Deploy Image Bot

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours to keep alive

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increase timeout for model download
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies (compatible versions)
      run: |
        pip install --upgrade pip
        # Ø¥ØµØ¯Ø§Ø±Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ numpy
        pip install "numpy==1.24.3"
        pip install "onnxruntime==1.15.1"
        pip install "opencv-python==4.8.1.78"
        pip install "rembg==2.0.30"
        pip install "Pillow==9.5.0"
        pip install "pyTelegramBotAPI==4.14.0"
        pip install "moviepy==1.0.3"
        pip install "numpy==1.24.3"  # Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ«Ù‡
        pip install "diffusers==0.24.0"
        pip install "transformers==4.34.0"
        pip install "accelerate==0.24.0"
        pip install "torch==2.0.1" --index-url https://download.pytorch.org/whl/cpu
        pip install "torchvision==0.15.2" --index-url https://download.pytorch.org/whl/cpu

    - name: Create .env file
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
        echo "USER_TAG=@AHMED_KHANA" >> .env
        echo "DEV_NOTE= Ø§Ù„Ù…Ø·ÙˆØ±" >> .env

    - name: Test Stable Diffusion setup
      run: |
        echo "ğŸ”„ Testing Stable Diffusion setup..."
        python -c "
        try:
            from diffusers import StableDiffusionPipeline
            import torch
            print('âœ… Stable Diffusion imports successful')
        except Exception as e:
            print(f'âŒ Stable Diffusion import failed: {e}')
            exit(1)
        "

    - name: Test rembg setup
      run: |
        echo "ğŸ”„ Testing rembg setup..."
        python -c "
        try:
            from rembg import remove
            print('âœ… rembg imports successful')
        except Exception as e:
            print(f'âŒ rembg import failed: {e}')
            exit(1)
        "

    - name: Run Image Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "ğŸš€ Starting bot..."
        python bot.py
